<!DOCTYPE html>
<html land="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A web interface for MQTT over Websockets">
    <meta name="author" content="Philip Wig">

    <title>Robotic Dashboard</title>
    
    <!-- Bootstrap core CSS: cyborg, darkly, superhero-->
    <link rel="stylesheet" href="/css/superhero/bootstrap.min.css">
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <a class="navbar-brand" href="#">Robotic Football Command Center</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <a class="nav-item nav-link active" href="/">Home <span class="sr-only">(current)</span></a>
          <a class="nav-item nav-link" href="/robotinfo">Robot Information</a>
          <a class="nav-item nav-link" href="/reprogramming">Reprogramming</a>
        </div>
      </div>
    </nav>
    <h1 class="text-center p-2">Overview of Robots</h1>
    <div class="container p-2">    
        <table class="table table-bordered" id="summtable">
          <thead>
            <tr>
              <th scope="col">Robot Number</th>
              <th scope="col">Battery Level</th>
              <th scope="col">Contoller Conencted</th>
              <th scope="col">Tackle Status</th>
            </tr>
          </thead>
          <tbody>
            
          </tbody>
        </table>
    </div>

    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>  
    <script src="/socket.io/socket.io.js"></script> <!-- include socket.io client side script -->

    <script>
      const socket = io(); //load socket.io-client and connect to the host that serves the page
      console.log("Started sockets");
      var firstPacket = true;

      socket.on('website',  function(message){    
        try {
          if (firstPacket){
            console.log("First packet: " + JSON.stringify(message));
            for (var key of Object.keys(message)) {
              if (!message[key].noData) {
                var row = $('<tr/ class=table-success id=' + key + '>');
                row.append($('<td/>').html(key.replace('r', '')));
                row.append($('<td/>').html(message[key].batteryLevel));
                row.append($('<td/>').html(message[key].contollerStatus));
                row.append($('<td/>').html(message[key].tackleStatus));
              }
              else {
                var row = $('<tr/ class=table-active id=' + key + '>');
                row.append($('<td/>').html(key.replace('r', '')));
                row.append($('<td/>').html(""));
                row.append($('<td/>').html(""));
                row.append($('<td/>').html(""));
              }
              $('#summtable').append(row); 
            } 
            firstPacket = false;
          }
          else {
            // Sample message: "{"1":{"batteryLevel":"33","contollerStatus":"Connected","tackleStatus":"tackled","newData":true,"noData":false},"2":{"newData":false,"noData":true}, ..."
            console.log("New packet: " + JSON.stringify(message));
            for (var key of Object.keys(message)) {
              if (message[key].noData) {
                var row = $('<tr/ class=table-active id=' + key + '>');
                row.append($('<td/>').html(key.replace('r', '')));
                row.append($('<td/>').html(""));
                row.append($('<td/>').html(""));
                row.append($('<td/>').html(""));
                $('#' + key).replaceWith(row);
              }
              else if (message[key].newData) {
                var row = $('<tr/ id=' + key + '>');
                
                row.append($('<td/ class=table-success >').html(key.replace('r', '')));
                
                row.append($('<td/ class=table-success >').html(message[key].batteryLevel));
                
                if (message[key].contollerStatus == "Disconnected") row.append($('<td/ class=table-info>').html(message[key].contollerStatus));
                else row.append($('<td/ class=table-success >').html(message[key].contollerStatus));
                
                if (message[key].tackleStatus == "Tackled") row.append($('<td/ class=table-danger>').html(message[key].tackleStatus));
                else row.append($('<td/ class=table-success>').html(message[key].tackleStatus));
                
                $('#' + key).replaceWith(row);
              }
            } 
          } 
        }
        catch(err) {
          console.log("Error: " + err.message);
        }  
      })
    </script>
  </body>
</html> 
